```{R}
myData = read.csv("D:/Projects/EM-algorithm/Iris.csv", header = TRUE, sep = ",") 
print(summary(myData))

plot(hist(myData$SepalLengthCm))
```

```{R}
plot(density(myData$SepalWidthCm))
```

```{R}
plot(density(myData$PetalLengthCm))
```

```{R}
plot(density(myData$PetalWidthCm))

```

```{R}
L <- function(x, mu, sigma, pi) {
  N <- length(x)
  K <- length(mu)
  total <- 0
  for (i in 1:N) {
    parts <- sapply(1:K, function(k) pi[k] * G(x[i], mu[k], sigma[k]))
    total <- total + log(sum(parts))
  }
  return(total)
}

estimate_gmm <- function(x, K, tol=0.001, max_iter=100) {
  N <- length(x)
  mu <- rep(runif(1), K)
  sigma <- rep(runif(1), K)
  pi <- rep(runif(1), K)
  curr_L <- Inf
  for (j in 1:max_iter) {
    prev_L <- curr_L
    
    r <- matrix(0, nrow = N, ncol = K)
    for (i in 1:N) {
      parts <- sapply(1:K, function(k) pi[k] * dnorm(x[i], mu[k], sigma[k]))
      total <- sum(parts)
      for (k in 1:K) {
        r[i, k] <- parts[k] / total
      }
    }
    
    rk <- colSums(r)
    for (k in 1:K) {
      pi[k] <- rk[k] / N
      mu[k] <- sum(r[, k] * x) / rk[k]
      sigma[k] <- sum(r[, k] * (x - mu[k])^2) / rk[k]
    }
    
    curr_L <- L(x, mu, sigma, pi)
    if (abs(prev_L - curr_L) < tol) {
      break
    }
  }
  return(list(mu = mu, sigma = sigma, pi = pi))
}

estimate_gmm(myData$SepalWidthCm, 1)
```

```{R}
em = estimate_gmm(myData$SepalWidthCm, 1)

means <- c(0.1, 0.5, 0.9)
sds <- c(1, 1, 1)
########################
# initial parameter estimates
theta0 <- c()

# E step: calculates conditional probabilities for latent variables
E_step <- function(theta, data = myData$SepalLengthCm) {
  comp1 <- theta[1] * dnorm(data, mean = theta[2], sd = theta[4])
  comp2 <- (1 - theta[1]) * dnorm(data, mean = theta[3], sd = theta[5])
  
  return(cbind(comp1/(comp1 + comp2),
               comp2/(comp1 + comp2)))
}

# M step: calculates the parameter estimates which maximise Q
M_step <- function(gammas, data = myData$SepalLengthCm) {
  pi <- mean(gammas[,1])
  
  mus <- c(weighted.mean(data, gammas[,1]),
           weighted.mean(data, gammas[,2]))
  
  sds <- sqrt(c(cov.wt(as.matrix(data), wt = gammas[,1])$cov,
                cov.wt(as.matrix(data), wt = gammas[,2])$cov))
  
  return(c(pi, mus, sds))
}

# run EM
epsilon <- 10e-8
N <- length(myData$SepalLengthCm)

mixture_likelihood <- function(theta, data = myData$SepalLengthCm) {
  comp1 <- theta[1] * dnorm(data, mean = theta[2], sd = theta[4])
  comp2 <- (1 - theta[1]) * dnorm(data, mean = theta[3], sd = theta[5])
  
  return(sum(log(comp1 + comp2)))
}

intermediate_values <- matrix(NA, ncol = 4, nrow = 150)
intermediate_values[1,] <- theta0

theta <- theta0
for (iter in 1:150) {
  old_theta <- theta
  mat <- E_step(theta)
  theta <- M_step(mat)
  
  intermediate_values[iter + 1,] <- theta
  
  # Check if significant change in likelihood
  if (abs(mixture_likelihood(theta) - mixture_likelihood(old_theta)) < epsilon) break
}

intermediate_values[iter + 1,]
```