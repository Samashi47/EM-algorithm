```{R}
initialize_parameters <- function(X, num_clusters) {
  n_samples <- dim(X)[1]
  n_features <- dim(X)[2]
  mean <- sample(X, num_clusters)
  cov <- list()
  for (i in 1:num_clusters) {
    cov[[i]] <- diag(n_features)
  }
  weight <- rep(1/num_clusters, num_clusters)
  return(list(mean=mean, cov=cov, weight=weight))
}
```

```{R}
multivariate_normal_pdf <- function(x, mean, cov) {
  k <- length(mean)
  det_cov <- det(cov)
  inv_cov <- solve(cov)
  exponent <- -0.5 * t(x - mean) %*% inv_cov %*% (x - mean)
  return((1 / ((2 * pi) ^ (k / 2) * sqrt(det_cov))) * exp(exponent))
}
```

```{R}
expectation_step <- function(X, mean, cov, weight) {
  num_clusters <- length(mean)
  n_samples <- dim(X)[1]
  responsibilities <- matrix(0, nrow=n_samples, ncol=num_clusters)
  for (i in 1:num_clusters) {
    for (j in 1:n_samples) {
      responsibilities[j, i] <- weight[i] * multivariate_normal_pdf(X[j, ], mean[[i]], cov[[i]])
    }
  }
  responsibilities <- responsibilities / rowSums(responsibilities)
  return(responsibilities)
}
```

```{R}
maximization_step <- function(X, responsibilities) {
  num_clusters <- ncol(responsibilities)
  n_samples <- nrow(X)
  
  weight <- colSums(responsibilities) / n_samples
  
  mean <- t(t(responsibilities) %*% X) / t(colSums(responsibilities))
  
  cov <- vector("list", num_clusters)
  for (i in 1:num_clusters) {
    cov[[i]] <- matrix(0, nrow = ncol(X), ncol = ncol(X))
    for (j in 1:n_samples) {
      diff <- X[j, ] - mean[i, ]
      cov[[i]] <- cov[[i]] + responsibilities[j, i] * outer(diff, diff)
    }
    cov[[i]] <- cov[[i]] / sum(responsibilities[, i])
  }
  
  return(list(mean = mean, cov = cov, weight = weight))
}
```

```{R}
calculate_log_likelihood <- function(X, mean, cov, weight) {
  num_clusters <- length(mean)
  n_samples <- nrow(X)
  log_likelihood <- 0
  for (i in 1:n_samples) {
    for (j in 1:num_clusters) {
        likelihood <- sum(weight[j] * dmvnorm(X[i, ], mean[j, ], cov[[j]]))
    }
    log_likelihood <- log_likelihood + log(likelihood)
  }
  return(log_likelihood)
}
```

```{R}
expectation_maximization <- function(X, num_clusters, max_iterations=100, tol=1e-4) {
  init_params <- initialize_parameters(X, num_clusters)

  mean <- init_params$mean
  cov <- init_params$cov
  weight <- init_params$weight
  
  for (iteration in 1:max_iterations) {
    responsibilities <- expectation_step(X, mean, cov, weight)
    
    max_params <- maximization_step(X, responsibilities)
    
    mean <- max_params$mean
    cov <- max_params$cov
    weight <- max_params$weight

    log_likelihood <- calculate_log_likelihood(X, mean, cov, weight)
    
    if (iteration > 1 && abs(log_likelihood - prev_log_likelihood) < tol) {
      break
    }
    
    prev_log_likelihood <- log_likelihood
  }
  
  return(list(mean, cov, weight))
}
```

```{R}
myData = read.csv("D:/Projects/EM-algorithm/data/Iris.csv", header = TRUE, sep = ",") 
```

```{R}
X = list(myData$PetalLengthCm, myData$PetalWidthCm)
```

```{R}
num_clusters <- 2
result <- expectation_maximization(X, num_clusters)

mean <- result$mean
cov <- result$cov
weight <- result$weight

responsibilities <- expectation_step(X, mean, cov, weight)
clusters <- apply(responsibilities, 1, which.max)
```